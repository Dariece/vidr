package de.daniel.marlinghaus.vidr.vulnerability.report.vo;

import com.fasterxml.jackson.annotation.JsonIgnore;
import de.daniel.marlinghaus.vidr.vulnerability.resolve.vo.GavVulnerableDependency;
import java.util.ArrayList;
import java.util.List;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Builder.Default;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;
import lombok.ToString;
import lombok.experimental.SuperBuilder;
import org.eclipse.collections.api.factory.Lists;
import org.eclipse.collections.api.list.ImmutableList;
import org.gradle.util.internal.VersionNumber;

@SuperBuilder
@Getter
@Setter
@ToString
@AllArgsConstructor
@NoArgsConstructor
public abstract class Vulnerability {

  //deserialized fields
  private String cveId;
  private String cveTitle;
  private CvssSeverity severity;
  private String actualVersion;
  private List<String> fixedVersions;
  private String dependencyName;

  //processed fields/methods
  @JsonIgnore
  private GavVulnerableDependency gavVulnerableDependency;

  /**
   * Can the vulnerability be fixed or not (fixed version available? Has known severity?)
   * <p>Hint: Needs additional condition for incompatibility; dependency name determinable?.</p>
   * @return Can the vulnerability be fixed or not
   */

  public Boolean isFixable() {
    return !getFixedVersions().isEmpty() && !CvssSeverity.UNKNOWN.equals(getSeverity());
  }

  public boolean isSameDependency(Vulnerability compare) {
    return getDependencyName().equals(compare.getDependencyName());
  }

  /**
   * @return the biggest fix version
   */
  public VersionNumber getMaxFixVersion() {
    return Lists.immutable.ofAll(getFixedVersions()).collect(VersionNumber::parse).max(VersionNumber::compareTo);
  }

  //TODO fix multiple call of parse in business logic
  public VersionNumber getActualVersionNumber() {
    return VersionNumber.parse(getActualVersion());
  }

  /**
   * @return all fixed versions as gradle versionNumber
   */
  public ImmutableList<VersionNumber> getFixedVersionNumbers() {
    return Lists.immutable.ofAll(getFixedVersions()).collect(VersionNumber::parse);
  }


  /**
   * Checks if severity of vulnerability is higher than medium
   *
   * @param vulnerability to be checked
   * @return condition is true or false
   */
  public static boolean checkSeverityIsHigherThanMedium(Vulnerability vulnerability) {
    return vulnerability.getSeverity().ordinal() > CvssSeverity.MEDIUM.ordinal();
  }

}
