package de.daniel.marlinghaus.vidr.vulnerability.report;

import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.ObjectMapper;
import de.daniel.marlinghaus.vidr.utils.configuration.JsonConfiguration;
import de.daniel.marlinghaus.vidr.utils.string.StringUtils;
import de.daniel.marlinghaus.vidr.vulnerability.report.vo.VulnerabilityReport;
import de.daniel.marlinghaus.vidr.vulnerability.report.vo.trivy.TrivyReport;
import de.daniel.marlinghaus.vidr.vulnerability.report.vo.trivy.TrivyVulnerability;
import de.daniel.marlinghaus.vidr.vulnerability.resolve.vo.GavVulnerableDependency;
import java.io.IOException;
import java.io.OutputStream;
import java.nio.file.Path;
import java.util.ArrayList;
import java.util.List;

public class TrivyReportDeserializer implements
    VulnerabilityReportDeserializer<TrivyVulnerability> {

  private OutputStream reportFile;
  private final ObjectMapper objectMapper = JsonConfiguration.objectMapper();

  @Override
  public VulnerabilityReport<TrivyVulnerability> deserialize(Path report) throws IOException {
    if (objectMapper.canDeserialize(objectMapper.constructType(TrivyVulnerability.class))) {
      return objectMapper.<TrivyReport>readValue(report.toFile(),
          new TypeReference<>() {
          });
    } else {
      throw new RuntimeException(
          "TrivyVulnerability can't be deserialized");//TODO use custom exception
    }
  }

  @Override
  public VulnerabilityReport<TrivyVulnerability> deserialize(OutputStream report) {
    return null;
  }

  @Override
  public List<GavVulnerableDependency> extractVulnerableDependencies(
      List<TrivyVulnerability> vulnerabilities) {
    List<GavVulnerableDependency> gavVulnerableDependencies = new ArrayList<>();

    vulnerabilities.stream()
        .filter(v -> StringUtils.notBlank(v.getDependencyName())).forEach(
            v -> {
              String[] packageSplit = v.getDependencyName().split(":");
              gavVulnerableDependencies.add(GavVulnerableDependency.builder()
                  .group(packageSplit[0])
                  .artifact(packageSplit[1])
                  .version(v.getActualVersion())
                  .severity(v.getSeverity())
                  .build());
            }
        );

    return gavVulnerableDependencies;
  }


  /**
   * @throws Exception
   */
  @Override
  public void close() throws Exception {
    if (reportFile != null) {
      reportFile.close();
    }
  }
}
