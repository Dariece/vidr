package de.daniel.marlinghaus.vidr.task;

import de.daniel.marlinghaus.vidr.vulnerability.scanner.vo.ScanFormat;
import de.daniel.marlinghaus.vidr.vulnerability.scanner.vo.ScanJob;
import de.daniel.marlinghaus.vidr.vulnerability.VulnerabilityScanStrategyDeterminer;
import de.daniel.marlinghaus.vidr.vulnerability.scanner.VulnerabilityScanner;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.OutputStream;
import java.net.URI;
import java.nio.file.Files;
import java.nio.file.Path;
import lombok.Getter;
import lombok.Setter;
import org.gradle.api.DefaultTask;
import org.gradle.api.provider.Property;
import org.gradle.api.tasks.Input;
import org.gradle.api.tasks.Internal;
import org.gradle.api.tasks.Optional;
import org.gradle.api.tasks.OutputFile;
import org.gradle.api.tasks.TaskAction;

public abstract class CreateVulnerabilityReport extends DefaultTask {

  /**
   * configured filePath for the scanable Object file (now sbom)
   */
  @Setter
  public Path scanObjectFile;

  /**
   * configured job for scan reporting
   */
  @Setter
  private ScanJob scanJob;

  /**
   * @return Property<VulnerabilityScanStrategyDeterminer> to determine a vulnerability scan
   * strategy that fits
   */
  @Internal
  public abstract Property<VulnerabilityScanStrategyDeterminer> getStrategyDeterminer();

  /**
   * @return Property<URI> configured URL for vulnerarbility service (now trivy)
   */
  @Input
  @Optional
  public abstract Property<URI> getServiceUrl();

  /**
   * file to write the scan result to for following tasks
   */
  @Getter
  @OutputFile
  @Optional
  private Path outputFile;

  @TaskAction
  void run() {
    if (ScanFormat.SBOM.equals(scanJob.getFormat())) { //TODO strategy pattern

      // pre configuration
      URI clientUrl = getServiceUrl().getOrElse(
          URI.create("http://localhost:8100")); // define default url
      this.outputFile = scanObjectFile.getParent().resolve(
          String.format("%s-%s-%s-trivy-report.json",
              scanJob.getApplicationName(),
              scanJob.getStage(),
              scanJob.getPipelineRun()));// define output filename depending on scanJob
      var log = getLogger(); //TODO add for each task and builder service

      log.info("Start trivy scan for sbom {} on url {}", scanObjectFile.getFileName().toString(),
          clientUrl); //TODO generify log or make it available in service

      try (VulnerabilityScanner scanService = getStrategyDeterminer().get()
          .determineScanService(clientUrl);
          OutputStream out = scanService.scan(scanJob,
              scanObjectFile); //execute scan
          OutputStream outFile = Files.newOutputStream(outputFile)) {
        // write scan result to output file
        ((ByteArrayOutputStream) out).writeTo(outFile);
      } catch (IOException e) {
        throw new RuntimeException(e); //TODO failure handling
      } catch (Exception e) {
        throw new RuntimeException(e);
      }

      log.info("Successful scanned sbom, write report to {}", outputFile.getFileName().toString());
    }
  }
}
